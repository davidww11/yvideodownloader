<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTubeä¸‹è½½åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #ff0000;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #cc0000;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ YouTubeä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>è®¾å¤‡ä¿¡æ¯</h2>
        <div id="deviceInfo" class="log" style="max-height: 150px;"></div>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•ä¸åŒçš„ä¸‹è½½æ–¹æ³•</h2>
        <button onclick="testDirectDownload()">æµ‹è¯•ç›´æ¥ä¸‹è½½é“¾æ¥</button>
        <button onclick="testBlobDownload()">æµ‹è¯• Blob ä¸‹è½½</button>
        <button onclick="testAPIDownload()">æµ‹è¯• API ä¸‹è½½</button>
        <button onclick="testMobileDownload()">æµ‹è¯•ç§»åŠ¨ç«¯ä¸‹è½½</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="test-section">
        <h2>å®æ—¶æ—¥å¿—</h2>
        <div id="log" class="log"></div>
    </div>

    <script>
        // Log function
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Device detection and info display
        function displayDeviceInfo() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            const deviceInfoEl = document.getElementById('deviceInfo');
            deviceInfoEl.textContent = `
è®¾å¤‡ç±»å‹: ${isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'æ¡Œé¢è®¾å¤‡'}
ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
æ˜¯å¦ Android: ${isAndroid ? 'æ˜¯' : 'å¦'}
æ˜¯å¦ iOS: ${isIOS ? 'æ˜¯' : 'å¦'}
å±å¹•å°ºå¯¸: ${window.screen.width} x ${window.screen.height}
è§†å£å°ºå¯¸: ${window.innerWidth} x ${window.innerHeight}
æ”¯æŒ Blob: ${window.Blob ? 'æ˜¯' : 'å¦'}
æ”¯æŒ URL.createObjectURL: ${window.URL && window.URL.createObjectURL ? 'æ˜¯' : 'å¦'}
            `;
        }

        // Test 1: Direct download link
        function testDirectDownload() {
            log('æµ‹è¯•ç›´æ¥ä¸‹è½½é“¾æ¥...');
            const a = document.createElement('a');
            a.href = 'data:text/plain;charset=utf-8,Hello%20World%21';
            a.download = 'test-direct.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            log('âœ… ç›´æ¥ä¸‹è½½è§¦å‘å®Œæˆ');
        }

        // Test 2: Blob download
        function testBlobDownload() {
            log('æµ‹è¯• Blob ä¸‹è½½...');
            const content = 'This is a test file created via Blob download method.';
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test-blob.txt';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            setTimeout(() => window.URL.revokeObjectURL(url), 100);
            log('âœ… Blob ä¸‹è½½è§¦å‘å®Œæˆ');
        }

        // Test 3: API download simulation
        function testAPIDownload() {
            log('æµ‹è¯• YouTube API ä¸‹è½½...');
            const testUrl = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
            
            fetch('/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: testUrl, format: 'mp4' })
            })
            .then(response => response.json())
            .then(data => {
                log('âœ… API å“åº”æˆåŠŸ');
                log(`è§†é¢‘æ ‡é¢˜: ${data.title}`);
                log(`å¯ç”¨æ ¼å¼æ•°é‡: ${data.formats ? data.formats.length : 0}`);
                
                if (data.formats && data.formats.length > 0) {
                    const format = data.formats[0];
                    log(`å°è¯•ä¸‹è½½ç¬¬ä¸€ä¸ªæ ¼å¼: ${format.quality}`);
                    log(`ä¸‹è½½ URL: ${format.url.substring(0, 50)}...`);
                    
                    // ä½¿ç”¨å¢å¼ºçš„ä¸‹è½½å‡½æ•°
                    downloadFile(format.url, format.filename);
                }
            })
            .catch(error => {
                log(`âŒ API æµ‹è¯•å¤±è´¥: ${error.message}`);
            });
        }

        // Enhanced download function (same as in main page)
        window.downloadFile = function(url, filename) {
            log(`å¼€å§‹ä¸‹è½½: ${filename}`);
            log(`URL: ${url.substring(0, 50)}...`);
            
            try {
                // Method 1: Try fetch and blob download
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        log('âœ… Fetch è¯·æ±‚æˆåŠŸï¼Œæ­£åœ¨åˆ›å»º Blob...');
                        return response.blob();
                    })
                    .then(blob => {
                        log(`âœ… Blob åˆ›å»ºæˆåŠŸï¼Œå¤§å°: ${blob.size} bytes`);
                        
                        // Create blob URL and download
                        const blobUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename || 'video.mp4';
                        a.style.display = 'none';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Clean up blob URL
                        setTimeout(() => window.URL.revokeObjectURL(blobUrl), 100);
                        
                        log('âœ… ä¸‹è½½é€šè¿‡ Fetch + Blob æ–¹æ³•æˆåŠŸè§¦å‘');
                    })
                    .catch(error => {
                        log(`âš ï¸ Fetch æ–¹æ³•å¤±è´¥: ${error.message}`);
                        log('ğŸ”„ å°è¯•ç›´æ¥ä¸‹è½½æ–¹æ³•...');
                        
                        // Method 2: Direct download link (fallback)
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename || 'video.mp4';
                        a.style.display = 'none';
                        a.setAttribute('target', '_self');
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        log('âœ… ç›´æ¥ä¸‹è½½æ–¹æ³•å·²è§¦å‘');
                    });
                
            } catch (error) {
                log(`âŒ ä¸‹è½½å®Œå…¨å¤±è´¥: ${error.message}`);
                
                // Last resort: try to open in new tab with download hint
                log('ğŸ†˜ å°è¯•æœ€åçš„å¤‡ç”¨æ–¹æ³•...');
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || 'video.mp4';
                link.target = '_blank';
                link.click();
                log('âœ… å¤‡ç”¨æ–¹æ³•å·²è§¦å‘ï¼ˆæ–°æ ‡ç­¾é¡µï¼‰');
            }
        };

        // Test 4: Mobile-specific download
        function testMobileDownload() {
            log('æµ‹è¯•ç§»åŠ¨ç«¯ä¸‹è½½æ–¹æ³•...');
            const testUrl = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            if (!isMobile) {
                log('âš ï¸ å½“å‰ä¸æ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œå°†æ¨¡æ‹Ÿç§»åŠ¨ç«¯ä¸‹è½½è¡Œä¸º');
            }
            
            fetch('/api/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: testUrl, format: 'mp4' })
            })
            .then(response => response.json())
            .then(data => {
                log('âœ… API å“åº”æˆåŠŸ');
                if (data.formats && data.formats.length > 0) {
                    const format = data.formats[0];
                    const downloadUrl = format.url;
                    
                    log(`å¼€å§‹æµ‹è¯•ç§»åŠ¨ç«¯ä¸‹è½½æ–¹æ³•...`);
                    log(`URL: ${downloadUrl.substring(0, 50)}...`);
                    
                    // æ¨¡æ‹Ÿç§»åŠ¨ç«¯ä¸‹è½½é€»è¾‘
                    try {
                        if (isAndroid || !isMobile) {
                            log('ä½¿ç”¨ window.location.href æ–¹æ³• (Android)');
                            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶é“¾æ¥è¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸æ˜¯ç›´æ¥è·³è½¬
                            const testLink = document.createElement('a');
                            testLink.href = downloadUrl;
                            testLink.textContent = 'ç‚¹å‡»æµ‹è¯•ç§»åŠ¨ç«¯ä¸‹è½½';
                            testLink.style.display = 'block';
                            testLink.style.color = '#ff0000';
                            testLink.style.marginTop = '10px';
                            testLink.style.textDecoration = 'underline';
                            testLink.onclick = function(e) {
                                e.preventDefault();
                                window.location.href = downloadUrl;
                                log('âœ… ç§»åŠ¨ç«¯ä¸‹è½½å·²è§¦å‘ (window.location.href)');
                            };
                            
                            const deviceInfoEl = document.getElementById('deviceInfo');
                            deviceInfoEl.appendChild(testLink);
                            
                        } else {
                            log('ä½¿ç”¨ window.open æ–¹æ³• (iOS)');
                            window.open(downloadUrl, '_blank');
                            log('âœ… ç§»åŠ¨ç«¯ä¸‹è½½å·²è§¦å‘ (window.open)');
                        }
                    } catch (error) {
                        log(`âŒ ç§»åŠ¨ç«¯ä¸‹è½½å¤±è´¥: ${error.message}`);
                    }
                }
            })
            .catch(error => {
                log(`âŒ API æµ‹è¯•å¤±è´¥: ${error.message}`);
            });
        }

        // Initial log
        log('YouTubeä¸‹è½½åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•å„ç§ä¸‹è½½æ–¹æ³•');
        
        // Display device info on load
        displayDeviceInfo();
    </script>
</body>
</html> 